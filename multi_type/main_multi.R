library(rstan)
rstan_options(auto_write = TRUE)           
options(mc.cores = parallel::detectCores())

population_GR <- 10423056    #Population numbers: https://www.worldometers.info/world-population/population-by-country/

# Population per age group, https://github.com/kieshaprem/synthetic-contact-matrices/blob/master/generate_synthetic_matrices/input/pop/poptotal.rdata
population1 <- 409459+471668+542237+526618  #0-15
population2 <- 529416+527800+597812+738703
population3 <- 780463+793946+796343+709351+676528
population4 <- 580634+549464+406619+394392+260756+104969+23197+2681
population_age_groups <- c(population1,population2,population3,population4)

# Aggregated synthetic contact matrix Prem, https://github.com/kieshaprem/synthetic-contact-matrices/blob/master/generate_synthetic_matrices/output/syntheticcontactmatrices2020/overall/contact_all.rdata
contact_matrix <- rbind(c(3.0676231,	0.6564019,	0.4840565, 0.07688583),
                        c(0.5959181,	1.7892037,	0.8486455, 0.08326917),
                        c(0.6848190,	1.2485640,	1.2366076, 0.18500133),
                        c(0.6779167,	0.5575842,	0.6264187, 0.55825333))

Greece_data <- read.csv('./data/Greece_age_dstr.csv', head = TRUE, sep=";")
full_cum_conf <- Greece_data[c(2:5)]
full_cum_dead <- Greece_data[c(7:10)]
timeGR <- Greece_data$ï.¿Date
fit_timeGR <- timeGR[(match("01/08/20", timeGR)):(match("28/02/21", timeGR))]
sample_daysGR <- length(fit_timeGR)
cum_conf <- data.matrix(full_cum_conf)[(match("01/08/20", timeGR)):(match("28/02/21", timeGR)),]
cum_dead <- data.matrix(full_cum_dead)[(match("01/08/20", timeGR)):(match("28/02/21", timeGR)),]

new_cases <- matrix(nrow=nrow(cum_conf), ncol=ncol(cum_conf))
for (i in 1:ncol(cum_conf)){
  new_cases[1,i] <- full_cum_conf[(match("01/08/20", timeGR)),i]-full_cum_conf[(match("31/07/20", timeGR)),i]
  for (t in 2:nrow(cum_conf)){ 
    new_cases[t,i] <- cum_conf[t,i]-cum_conf[t-1,i]
  }
}
aggregate_new_cases <- rowSums(new_cases)
deaths <- matrix(nrow=nrow(cum_dead), ncol=ncol(cum_dead))
for (i in 1:ncol(cum_conf)){
  deaths[1,i] <- full_cum_dead[(match("01/08/20", timeGR)),i]-full_cum_dead[(match("31/07/20", timeGR)),i]
  for (t in 2:nrow(cum_conf)){ 
    deaths[t,i] <- cum_dead[t,i]-cum_dead[t-1,i]
  }
}
aggregate_deaths <- rowSums(deaths)

# Discretize infection to death distribution
infection_death = rep(0,sample_daysGR)
infection_death[1] = pgamma(1.5,shape=6.29,rate =0.26) - pgamma(0,shape=6.29,rate =0.26)
for(i in 2:length(infection_death)) {
  infection_death[i] = pgamma(i+.5,shape=6.29,rate =0.26) - pgamma(i-.5,shape=6.29,rate =0.26)
}

S0_M <- c(1949582,2391731,3754131,2322512)
I0_M <- c(400,2000,2500,200)
mean_ifr <- c(0.007994,0.0115)

# Modify data into a form suitable for Stan
cov_data = list( N_g = population_age_groups,
                 n_obs = sample_daysGR,
                 n_groups = 4,
                 yD = aggregate_deaths,
                 S0 = S0_M,
                 I0 = I0_M,
                 C_M = contact_matrix,
                 I_D = infection_death,
                 IFRmu = mean_ifr,
                 ifr_cp1 = 163,
                 v0=0)

# Specify parameters to monitor
parameters = c("mu", "sigma_mu", "p", "w", "phi", "sigma","ifr", "phiD", 
               "c_i", "raw_c_i", "c_tot", "muD", "S", "I_tot",  "removals",
               "r", "sigmaOU")

n_chains=4
n_warmups=6000
n_iter=16000
n_thin=10
set.seed(1234)

init_cases <- 100 + c(325, 334, 341, 348, 356, 363, 371, 377, 384, 392, 397, 405, 410, 420, 426, 434, 441, 450, 460, 469, 479, 489, 503, 516, 527, 543, 555, 570, 585, 597, 607, 618, 630, 639, 645, 649, 655, 661, 666, 667, 671, 682, 690, 701, 715, 733, 751, 779, 806, 834, 865, 901, 938, 972, 1007, 1036, 1064, 1089, 1107, 1117, 1120, 1112, 1102, 1087, 1076, 1071, 1058, 1058, 1056, 1062, 1078, 1103, 1140, 1193, 1256, 1350, 1472, 1616, 1810, 2043, 2343, 2701, 3157, 3712, 4354, 5090, 5862, 6717, 7592, 8405, 9154, 9811, 10343, 10745, 11043, 11279, 11397, 11421, 11313, 11161, 10902, 10587, 10237, 9866, 9442, 9030, 9250, 8500, 7950, 7673, 7399, 7119, 6927, 6800, 6700, 6389, 6215, 6034, 5868, 5710, 5538, 5369, 5221, 5052, 4882, 4703, 4509, 4500, 4166, 4006, 3836, 3685, 3544, 3412, 3500, 3500, 3019, 2905, 2801, 2687, 2585, 2600, 2500, 2294, 2211, 2137, 2069, 2300, 2100, 1900, 1863, 1833, 1806, 1787, 1771, 1764, 1763, 1772, 1785, 1803, 1823, 1849, 1868, 1873, 1879, 1878, 1882, 1882, 1890, 1899, 1909, 1914, 1925, 1938, 1945, 1967, 1984, 2006, 2029, 2055, 2082, 2123, 2166, 2226, 2284, 2356, 2434, 2509, 2598, 2698, 2806, 2921, 3046, 3175, 3314, 3462, 3613, 3761, 3920, 4077, 4237, 4396, 4528, 4655, 4800, 4915, 5022, 5121, 5201, 5280, 5346, 5392)
init_cases_i <- rbind(c(23, 24, 24, 25, 25, 26, 27, 27, 28, 28, 28, 29, 29, 30, 31, 31, 32, 32, 33, 34, 34, 35, 36, 37, 38, 39, 40, 41, 42, 
                        43, 44, 45, 45, 46, 47, 47, 47, 48, 48, 48, 48, 49, 50, 51, 52, 53, 54, 56, 58, 60, 63, 65, 68, 70, 73, 75, 77, 79, 
                        80, 81, 81, 81, 80, 79, 78, 78, 77, 77, 77, 77, 78, 80, 83, 87, 91, 98, 107, 117, 132, 149, 170, 196, 230, 270, 317, 
                        371, 427, 489, 553, 612, 667, 715, 754, 783, 805, 822, 831, 832, 825, 814, 795, 772, 746, 719, 688, 658, 674, 619, 
                        579, 559, 539, 519, 505, 495, 488, 465, 453, 440, 427, 416, 403, 391, 380, 368, 356, 343, 328, 328, 303, 292, 279, 
                        268, 258, 248, 255, 255, 220, 211, 204, 195, 188, 189, 182, 167, 161, 155, 150, 167, 153, 138, 135, 133, 131, 130,
                        129, 128, 128, 129, 130, 131, 132, 134, 136, 136, 137, 136, 137, 137, 137, 138, 139, 139, 140, 141, 141, 143, 144, 
                        146, 147, 149, 151, 154, 157, 162, 166, 171, 177, 182, 189, 196, 204, 213, 222, 231, 241, 252, 263, 274, 285, 297, 
                        309, 320, 330, 339, 350, 358, 366, 373, 379, 385, 385, 385),
                      c(148, 152, 155, 158, 162, 165, 169, 171, 174, 178, 180, 184, 186, 191, 194, 197, 200, 205, 209, 213, 218, 222, 229, 
                        235, 240, 247, 252, 259, 266, 272, 276, 281, 287, 291, 293, 295, 298, 301, 303, 303, 305, 310, 314, 319, 325, 334, 
                        342, 354, 367, 380, 394, 410, 427, 442, 458, 472, 484, 496, 504, 509, 510, 506, 502, 495, 490, 488, 482, 482, 481,
                        483, 491, 502, 519, 543, 572, 615, 670, 736, 824, 930, 1067, 1230, 1438, 1691, 1984, 2319, 2671, 3060, 3459, 3830, 
                        4171, 4470, 4713, 4896, 5032, 5139, 5193, 5204, 5155, 5086, 4968, 4824, 4664, 4495, 4302, 4114, 4215, 3873, 3622, 
                        3496, 3371, 3244, 3156, 3098, 3053, 2911, 2832, 2749, 2674, 2602, 2523, 2446, 2379, 2302, 2224, 2143, 2054, 2050, 
                        1898, 1825, 1748, 1679, 1614, 1554, 1594, 1594, 1375, 1323, 1276, 1224, 1177, 1184, 1139, 1045, 1007, 973, 942, 1048,
                        956, 865, 848, 835, 822, 814, 807, 803, 803, 807, 813, 821, 830, 842, 851, 853, 856, 855, 857, 857, 861, 865, 869, 
                        872, 877, 883, 886, 896, 904, 914, 924, 936, 948, 967, 987, 1014, 1040, 1073, 1109, 1143, 1183, 1229, 1278, 1331,
                        1388, 1446, 1510, 1577, 1646, 1713, 1786, 1857, 1930, 2003, 2063, 2121, 2187, 2239, 2288, 2333, 2370, 2406, 2406, 2406),
                      c(119, 122, 125, 127, 130, 133, 136, 138, 140, 143, 145, 148, 150, 154, 156, 159, 161, 165, 168, 172, 175, 179, 184, 
                        189, 193, 199, 203, 209, 214, 219, 222, 226, 231, 234, 236, 238, 240, 242, 244, 244, 246, 250, 253, 257, 262, 269, 
                        275, 285, 295, 306, 317, 330, 344, 356, 369, 380, 390, 399, 406, 409, 411, 408, 404, 398, 394, 393, 388, 388, 387, 
                        389, 395, 404, 418, 437, 460, 495, 540, 593, 664, 749, 859, 991, 1158, 1362, 1598, 1868, 2151, 2465, 2786, 3084, 
                        3359, 3600, 3796, 3943, 4053, 4139, 4183, 4191, 4152, 4096, 4001, 3885, 3757, 3621, 3465, 3314, 3395, 3119, 2917, 
                        2816, 2715, 2612, 2542, 2495, 2459, 2344, 2281, 2214, 2153, 2095, 2032, 1970, 1916, 1854, 1791, 1726, 1654, 1651, 
                        1529, 1470, 1407, 1352, 1300, 1252, 1284, 1284, 1108, 1066, 1028, 986, 948, 954, 917, 841, 811, 784, 759, 844, 770, 
                        697, 683, 672, 662, 655, 650, 647, 647, 650, 655, 661, 669, 678, 685, 687, 689, 689, 690, 690, 693, 696, 700, 702,
                        706, 711, 713, 721, 728, 736, 744, 754, 764, 779, 794, 817, 838, 864, 893, 920, 953, 990, 1029, 1072, 1117, 1165, 
                        1216, 1270, 1326, 1380, 1438, 1496, 1555, 1613, 1661, 1708, 1761, 1803, 1843, 1879, 1908, 1937, 1937, 1937),
                      c(33, 34, 35, 36, 37, 37, 38, 39, 40, 40, 41, 42, 42, 43, 44, 45, 46, 46, 47, 48, 49, 51, 52, 53, 54, 56, 57, 59, 61, 
                        62, 63, 64, 65, 66, 67, 67, 68, 68, 69, 69, 70, 71, 71, 73, 74, 76, 78, 81, 84, 87, 90, 94, 97, 101, 105, 108, 111, 
                        113, 115, 116, 116, 116, 114, 113, 112, 111, 110, 110, 110, 110, 112, 115, 118, 124, 131, 140, 153, 168, 188, 213, 
                        244, 281, 329, 387, 454, 531, 611, 700, 792, 876, 955, 1023, 1079, 1121, 1152, 1176, 1189, 1191, 1180, 1164, 1137,
                        1104, 1068, 1029, 985, 942, 965, 886, 829, 800, 771, 742, 722, 709, 699, 666, 648, 629, 612, 595, 577, 560, 544, 527,
                        509, 490, 470, 469, 434, 417, 400, 384, 369, 356, 365, 365, 314, 303, 292, 280, 269, 271, 260, 239, 230, 222, 215, 
                        239, 219, 198, 194, 191, 188, 186, 184, 184, 183, 184, 186, 188, 190, 192, 194, 195, 196, 195, 196, 196, 197, 198, 
                        199, 199, 200, 202, 202, 205, 207, 209, 211, 214, 217, 221, 225, 232, 238, 245, 253, 261, 271, 281, 292, 304, 317, 
                        331, 345, 361, 376, 392, 409, 425, 442, 458, 472, 485, 500, 512, 523, 534, 542, 550, 550, 550))

raw_init_cases_i <- init_cases_i + 10

# Set initial values:
inits = function(){
  list(
    p=runif(1,0.1,0.9),
    ifr=c(runif(1,0.00797,0.00801), runif(1,0.01145,0.01155)),
    reciprocal_phiD=runif(1,0.5,1.5),
    phi=runif(1,0.5,6.5), sigma_sq=runif(1,0.5,4.5),
    c_i = init_cases_i + runif(1,-5, 10),
    raw_c_i = raw_init_cases_i,
    mu = contact_matrix,
    c_tot = init_cases + runif(1,-5, 100),
    sigma_mu=runif(1,0.02,4.5)
  )
}

#test = stan("multi_type_CB.stan",  data = cov_data, init = inits, pars = parameters, chains = 1, iter = 3,control=list(adapt_delta=0.99, max_treedepth=16),seed=4321)

nuts_fit_multi = stan("multi_type_CB.stan", 
                      data = cov_data, 
                      pars = parameters, 
                      init = inits, 
                      chains = n_chains, 
                      warmup = n_warmups, 
                      iter = n_iter, 
                      thin=n_thin, 
                      control=list(adapt_delta=0.99, max_treedepth=16), seed=4321)